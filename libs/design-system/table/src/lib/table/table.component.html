<!-- TODO fix overflow fade
  hraScrollOverflowFade
  [scrollOverflowFadeOffset]="40"
-->
<ng-scrollbar
  externalViewport=".scroll-viewport"
  externalContentWrapper=".content-wrapper"
  externalSpacer="content-wrapper"
  asyncDetection="auto"
  #scrollbar
>
  <div class="scroll-viewport">
    <div class="content-wrapper">
      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        [matSortDisabled]="!enableSort()"
        [class.vertical-divider]="verticalDividers()"
        aria-label="Table with sort function"
      >
        @let templates = { text, numeric, markdown, link, icon, menu };

        <!-- Selection Column (if enabled) -->
        @if (enableRowSelection()) {
          <ng-container matColumnDef="select">
            @if (!hideHeaders()) {
              <th mat-header-cell *matHeaderCellDef data-column-type="checkbox">
                <mat-checkbox
                  aria-label="Hide all"
                  hraPlainTooltip="Hide all"
                  [checked]="selection.hasValue() && isAllSelected()"
                  [indeterminate]="selection.hasValue() && !isAllSelected()"
                  (change)="toggleAllRows()"
                  disableRipple
                >
                </mat-checkbox>
              </th>
            }
            <td mat-cell *matCellDef="let element" data-column-type="checkbox">
              <mat-checkbox
                aria-label="Hide"
                hraPlainTooltip="Hide"
                (click)="$event.stopPropagation()"
                (change)="$event ? toggleRow(element) : null"
                [checked]="selection.isSelected(element)"
                disableRipple
              >
              </mat-checkbox>
            </td>
          </ng-container>
        }

        @for (column of _columns(); track column.column) {
          @let type = getColumnType(column);
          @let template = templates[type];

          <ng-container [matColumnDef]="column.column">
            @if (!hideHeaders()) {
              <th
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                [attr.data-column-type]="type"
                [sortActionDescription]="`Sort by ${column.label}`"
              >
                {{ column.label }}
              </th>
            }
            <td mat-cell *matCellDef="let element" [attr.data-column-type]="type">
              <ng-container
                *ngTemplateOutlet="template; context: { $implicit: element[column.column], element, column }"
              />
            </td>
          </ng-container>
        }

        @if (!hideHeaders()) {
          <tr mat-header-row *matHeaderRowDef="columnIds(); sticky: true"></tr>
        }
        <tr mat-row *matRowDef="let row; let i = index; columns: columnIds()"></tr>
      </table>

      <ng-content />
    </div>
  </div>
</ng-scrollbar>

<ng-template hraTextRowElement #text let-text>
  <span class="text">{{ text }}</span>
</ng-template>

<ng-template hraNumericRowElement #numeric let-value>
  <span class="numeric">{{ value | number }}</span>
</ng-template>

<ng-template hraMarkdownRowElement #markdown let-markdown>
  <markdown class="markdown" [data]="markdown" />
</ng-template>

<ng-template hraIconRowElement #icon let-icon let-column="column" let-element="element">
  <hra-icon [svgIcon]="icon" [hraPlainTooltip]="element[column.type.tooltip]"></hra-icon>
</ng-template>

<ng-template hraMenuButtonRowElement #menu let-column="column" let-element="element">
  @let options = element[column.type.options];
  <button
    mat-icon-button
    [matMenuTriggerFor]="menuOptions"
    [hraPlainTooltip]="column.type.tooltip"
    (mouseover)="downloadButtonHover(element['id'])"
    (focus)="downloadButtonHover(element['id'])"
  >
    <hra-icon [fontIcon]="column.type.icon"></hra-icon>
  </button>

  <mat-menu #menuOptions="matMenu" class="table-menu">
    @for (option of getMenuOptions(options); track $index) {
      <a
        mat-menu-item
        [attr.href]="option.url"
        download
        (click)="$event.preventDefault(); download(option.url!); snackbar.open('File downloaded', '', false, 'start')"
      >
        <mat-icon>{{ option.icon }}</mat-icon>
        <div class="option-text">
          <span class="option-name">
            {{ option.name }}
          </span>
          <span class="option-description">
            {{ option.description }}
          </span>
        </div>
      </a>
    }
  </mat-menu>
</ng-template>

<ng-template hraLinkRowElement #link let-label let-column="column" let-element="element">
  @let url = element[column.type.urlColumn];
  @let isInternal = column.type.internal;
  @if (isInternal) {
    <a hraHyperlink class="link internal" tabindex="0" (keyup)="routeClick(url)" (click)="routeClick(url)">
      {{ label }}
    </a>
  } @else {
    <a hraHyperlink class="link" [attr.href]="url">
      {{ label }}
    </a>
  }
</ng-template>
