@let ctaConfig = cta();
@let isLargeScreen = isLargeScreen$ | async;
@let isMobileMenuOpen = !isLargeScreen && isMenuActive('main');

@if (ctaConfig && !ctaDismissed) {
  <div class="cta" #ctaEl>
    <hra-cta-bar
      [action]="ctaConfig.action"
      [description]="ctaConfig.description"
      [url]="ctaConfig.url"
      (closeClick)="ctaDismissed = true"
    >
    </hra-cta-bar>
  </div>
}

<header
  class="header"
  [class.mobile-menu-open]="isMobileMenuOpen"
  cdkOverlayOrigin
  #headerEl
  #headerOrigin="cdkOverlayOrigin"
>
  <div class="menus" #menusEl>
    <hra-brand-logo size="small"></hra-brand-logo>

    <div class="filler"></div>

    @if (isLargeScreen) {
      @for (menu of menus().menus; track menu.id) {
        <!-- TODO aria attributes -->
        <hra-navigation-category-toggle
          cdkOverlayOrigin
          [toggled]="isMenuActive(menu)"
          (toggledChange)="toggleMenu(menu)"
          #menuToggle="cdkOverlayOrigin"
        >
          {{ menu.label }}
        </hra-navigation-category-toggle>

        <ng-template
          cdkConnectedOverlay
          cdkConnectedOverlayHasBackdrop="false"
          cdkConnectedOverlayLockPosition="true"
          [cdkConnectedOverlayOpen]="isMenuActive(menu)"
          [cdkConnectedOverlayOrigin]="menuToggle"
          [cdkConnectedOverlayPositions]="desktopMenuPositions"
          cdkConnectedOverlayPush="true"
          (overlayOutsideClick)="toggleMenu(menu)"
        >
          <hra-desktop-menu [menu]="menu" [style.max-height]="desktopMenuMaxHeight()"></hra-desktop-menu>
        </ng-template>
      }
    }

    <!-- TODO aria -label, -expanded, -controls -->
    <button mat-icon-button cdkOverlayOrigin (click)="toggleMenu('main')" #mainMenuToggle="cdkOverlayOrigin">
      <mat-icon>
        @if (isMenuActive('main')) {
          close
        } @else if (isLargeScreen) {
          apps
        } @else {
          menu
        }
      </mat-icon>
    </button>

    @if (isLargeScreen) {
      <ng-template
        cdkConnectedOverlay
        cdkConnectedOverlayHasBackdrop="false"
        cdkConnectedOverlayLockPosition="true"
        [cdkConnectedOverlayOpen]="isMenuActive('main')"
        [cdkConnectedOverlayOrigin]="mainMenuToggle"
        [cdkConnectedOverlayPositions]="desktopMenuPositions"
        cdkConnectedOverlayPush="true"
        (overlayOutsideClick)="toggleMenu('main')"
      >
        <hra-desktop-menu [menu]="hubmapMenu()" [style.max-height]="desktopMenuMaxHeight()"></hra-desktop-menu>
      </ng-template>
    } @else {
      <ng-template
        cdkConnectedOverlay
        cdkConnectedOverlayDisposeOnNavigation="true"
        cdkConnectedOverlayHasBackdrop="false"
        cdkConnectedOverlayLockPosition="true"
        [cdkConnectedOverlayHeight]="mobileMenuHeight()"
        [cdkConnectedOverlayOpen]="isMenuActive('main')"
        [cdkConnectedOverlayOrigin]="headerOrigin"
        [cdkConnectedOverlayPositions]="mobileMenuPositions"
        cdkConnectedOverlayWidth="100%"
        #mobileMenuOverlay
      >
        <hra-mobile-menu [hubmapMenu]="hubmapMenu()" [menus]="menus()"></hra-mobile-menu>
      </ng-template>
    }
  </div>

  @if (breadcrumbs().length > 0) {
    <mat-divider></mat-divider>

    <div class="navigation">
      <hra-breadcrumbs [crumbs]="breadcrumbs()"> </hra-breadcrumbs>
      <div class="filler"></div>
    </div>
  }
</header>

<!-- TODO progress -->
