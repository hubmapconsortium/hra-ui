<form class="content" [formGroup]="visualizationForm" hraFeature="create-visualization-page">
  <div class="page-nav">
    <h1 class="title">Create a Cell Distance Visualization</h1>
  </div>

  <hra-workflow-card
    class="card data-upload"
    [allowUpload]="true"
    [loadProgress]="nodeProgress"
    hraFeature="upload-data"
  >
    <h2 class="header">
      <hra-step-indicator class="step-number" [value]="1"></hra-step-indicator>
      <span class="card-title">Upload Data</span>

      <hra-info-button [richTooltipContent]="uploadDataTooltip" />

      <hra-rich-tooltip-container #uploadDataTooltip>
        <hra-rich-tooltip-content>
          <hra-tooltip-card [content]="tooltips[0]"> </hra-tooltip-card>
        </hra-rich-tooltip-content>
      </hra-rich-tooltip-container>

      <div class="filler"></div>
      <a
        mat-button
        class="use-template"
        color="primary"
        href="https://docs.google.com/spreadsheets/d/1EUf7CUZb0NprgxBeX3nS3GXyUM89edIRH6NSeUsR3nY/edit?gid=47698780#gid=47698780"
        target="_blank"
        rel="noopener noreferrer"
        hraButtonSize="medium"
        hraFeature="data-template"
        hraClickEvent
      >
        Template
      </a>
    </h2>
    <table aria-label="data upload requirements">
      <tr>
        <th>Required Columns</th>
        <th>Optional Columns</th>
        <th>Supported Format</th>
      </tr>

      <tr>
        <td>• <span>X</span></td>
        <td>• <span>Z</span></td>
        <td>• <span>CSV</span></td>
      </tr>
      <tr>
        <td>• <span>Y</span></td>
        <td>• <span>Cell Ontology ID</span></td>
      </tr>
      <tr>
        <td>• <span>Cell Type</span></td>
      </tr>
    </table>

    <cde-file-upload
      class="upload-csv"
      accept="text/csv,.csv"
      [loader]="nodesLoader"
      [options]="nodesLoaderOptions"
      (loadStarted)="clearNodes()"
      (loadCompleted)="setNodes($event[0])"
      (loadCancelled)="clearNodes()"
      (loadErrored)="nodesLoadError = $event; nodeProgress = 0"
      [errorMessage]="nodesErrorMessage"
      [errorActionMessage]="nodesErrorActionMessage"
      (progress)="nodeProgress = $event"
      #nodesFileUpload
    >
    </cde-file-upload>
  </hra-workflow-card>

  <hra-workflow-card class="card organize-data" formGroupName="headers" hraFeature="organize-data">
    <h2 class="header">
      <hra-step-indicator class="step-number" [value]="2"></hra-step-indicator>
      <span class="card-title">Organize Data</span>

      <hra-info-button [richTooltipContent]="organizeDataTooltip" />

      <hra-rich-tooltip-container #organizeDataTooltip>
        <hra-rich-tooltip-content>
          <hra-tooltip-card [content]="tooltips[1]"> </hra-tooltip-card>
        </hra-rich-tooltip-content>
      </hra-rich-tooltip-container>
    </h2>

    @if (visualizationForm.controls.headers.disabled) {
      <hra-error-indicator [errors]="['Please upload a dataset.']"></hra-error-indicator>
    }

    <div class="required-headers">
      <span class="subheader">Required: Verify column headers</span>

      <mat-form-field subscriptSizing="dynamic" hraFeature="x-axis-selector">
        <mat-label>X Axis</mat-label>
        <mat-select
          disableRipple
          formControlName="xAxis"
          panelClass="options-container"
          hraClickEvent
          hraModelChangeEvent
          cdeMarkEmptyFormControl
        >
          @for (option of dataHeaders; track option) {
            <mat-option [value]="option">{{ option }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field subscriptSizing="dynamic" hraFeature="y-axis-selector">
        <mat-label>Y Axis</mat-label>
        <mat-select
          disableRipple
          formControlName="yAxis"
          panelClass="options-container"
          hraClickEvent
          hraModelChangeEvent
          cdeMarkEmptyFormControl
        >
          @for (option of dataHeaders; track option) {
            <mat-option [value]="option">{{ option }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field class="cell-type-select" subscriptSizing="dynamic" hraFeature="cell-type-selector">
        <mat-label>Cell Type</mat-label>
        <mat-select
          disableRipple
          formControlName="cellType"
          panelClass="options-container"
          hraClickEvent
          hraModelChangeEvent
          cdeMarkEmptyFormControl
        >
          @for (option of dataHeaders; track option) {
            <mat-option [value]="option">{{ option }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    @if (columnErrorActionMessage) {
      <hra-error-indicator [errors]="[columnErrorActionMessage]"></hra-error-indicator>
    }

    <div class="optional-headers">
      <span class="subheader">Optional: Add column headers</span>

      <mat-form-field subscriptSizing="dynamic" hraFeature="z-axis-selector">
        <mat-label>Z Axis</mat-label>
        <mat-select
          disableRipple
          formControlName="zAxis"
          panelClass="options-container"
          hraClickEvent
          hraModelChangeEvent
          cdeMarkEmptyFormControl
        >
          @for (option of dataHeaders; track option) {
            <mat-option [value]="option">{{ option }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field subscriptSizing="dynamic" hraFeature="cell-ontology-selector">
        <mat-label>Cell Ontology ID</mat-label>
        <mat-select
          disableRipple
          formControlName="ontologyId"
          panelClass="options-container"
          hraClickEvent
          hraModelChangeEvent
          cdeMarkEmptyFormControl
        >
          @for (option of dataHeaders; track option) {
            <mat-option [value]="option">{{ option }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
  </hra-workflow-card>

  <hra-workflow-card class="card parameters" formGroupName="parameters" hraFeature="configure-parameters">
    <h2 class="header">
      <hra-step-indicator class="step-number" [value]="3"></hra-step-indicator>
      <div class="card-title">Configure Parameters</div>
      <hra-info-button [richTooltipContent]="parametersTooltip" />

      <hra-rich-tooltip-container #parametersTooltip>
        <hra-rich-tooltip-content>
          <hra-tooltip-card [content]="tooltips[2]"> </hra-tooltip-card>
        </hra-rich-tooltip-content>
      </hra-rich-tooltip-container>
    </h2>

    @if (visualizationForm.controls.parameters.disabled) {
      <hra-error-indicator [errors]="['Please upload a dataset.']"></hra-error-indicator>
    }

    <div class="parameters-1">
      <mat-form-field subscriptSizing="dynamic" hraFeature="anchor-cell-type-selector">
        <mat-label>Anchor Cell Type</mat-label>
        <mat-select
          disableRipple
          formControlName="nodeTargetValue"
          panelClass="options-container"
          hraClickEvent
          hraModelChangeEvent
          cdeMarkEmptyFormControl
        >
          @for (type of cellTypes; track type) {
            <mat-option [value]="type">{{ type }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field subscriptSizing="dynamic" hraFeature="distance-threshold">
        <mat-label>Distance Threshold</mat-label>
        <input matInput formControlName="distanceThreshold" hraClickEvent cdeMarkEmptyFormControl />
      </mat-form-field>
    </div>

    <div class="parameters-2">
      <mat-form-field subscriptSizing="dynamic" hraFeature="pixel-size-x">
        <mat-label>Pixel size (X) (µm/pixel)</mat-label>
        <input matInput type="number" formControlName="pixelSizeX" min="0" hraClickEvent cdeMarkEmptyFormControl />
      </mat-form-field>

      <mat-form-field subscriptSizing="dynamic" hraFeature="pixel-size-y">
        <mat-label>Pixel size (Y) (µm/pixel)</mat-label>
        <input matInput type="number" formControlName="pixelSizeY" min="0" hraClickEvent cdeMarkEmptyFormControl />
      </mat-form-field>

      <mat-form-field subscriptSizing="dynamic" hraFeature="pixel-size-z">
        <mat-label>Pixel size (Z) (µm/pixel)</mat-label>
        <input matInput type="number" formControlName="pixelSizeZ" min="0" hraClickEvent cdeMarkEmptyFormControl />
      </mat-form-field>
    </div>
  </hra-workflow-card>

  <hra-workflow-card class="card metadata" formGroupName="metadata" hraFeature="add-metadata">
    <h2 class="header">
      <hra-step-indicator class="step-number" [value]="4"></hra-step-indicator>
      <div class="card-title">Optional: Add Metadata</div>
      <hra-info-button [richTooltipContent]="metadataTooltip" />

      <hra-rich-tooltip-container #metadataTooltip>
        <hra-rich-tooltip-content>
          <hra-tooltip-card [content]="tooltips[3]"> </hra-tooltip-card>
        </hra-rich-tooltip-content>
      </hra-rich-tooltip-container>
    </h2>

    <div class="row">
      <mat-form-field subscriptSizing="dynamic" hraFeature="visualization-title">
        <mat-label>Visualization Title</mat-label>
        <input matInput formControlName="title" hraClickEvent cdeMarkEmptyFormControl />
      </mat-form-field>

      <mat-form-field subscriptSizing="dynamic" hraFeature="imaging-technology">
        <mat-label>Imaging Technology</mat-label>
        <input matInput formControlName="technology" hraClickEvent cdeMarkEmptyFormControl />
      </mat-form-field>
    </div>

    <div class="row">
      <mat-form-field subscriptSizing="dynamic" hraFeature="organ-selector">
        <mat-label>Organ</mat-label>
        <mat-select
          disableRipple
          formControlName="organ"
          panelClass="options-container"
          hraClickEvent
          hraModelChangeEvent
          cdeMarkEmptyFormControl
        >
          @for (organ of organs(); track organ.id) {
            <mat-option [value]="organ">{{ organ.label | titlecase }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field subscriptSizing="dynamic" hraFeature="sex-selector">
        <mat-label>Sex</mat-label>
        <mat-select
          disableRipple
          formControlName="sex"
          panelClass="options-container"
          hraClickEvent
          hraModelChangeEvent
          cdeMarkEmptyFormControl
        >
          <mat-option value="Male">Male</mat-option>
          <mat-option value="Female">Female</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="row">
      <mat-form-field subscriptSizing="dynamic" hraFeature="age">
        <mat-label>Age</mat-label>
        <input matInput type="number" formControlName="age" min="0" max="120" hraClickEvent cdeMarkEmptyFormControl />
      </mat-form-field>

      <mat-form-field subscriptSizing="dynamic" hraFeature="thickness">
        <mat-label>Thickness (µm)</mat-label>
        <input matInput type="number" formControlName="thickness" min="0" hraClickEvent cdeMarkEmptyFormControl />
      </mat-form-field>
    </div>
  </hra-workflow-card>

  <hra-workflow-card
    class="color-config card"
    [class.custom]="useCustomColorMap"
    [allowUpload]="true"
    [loadProgress]="colorProgress"
    hraFeature="configure-colors"
  >
    <h2 class="header">
      <hra-step-indicator class="step-number" [value]="5"></hra-step-indicator>
      <div class="card-title">Optional: Configure Colors</div>
      <hra-info-button [richTooltipContent]="colorsTooltip" />

      <hra-rich-tooltip-container #colorsTooltip>
        <hra-rich-tooltip-content>
          <hra-tooltip-card [content]="tooltips[4]"> </hra-tooltip-card>
        </hra-rich-tooltip-content>
      </hra-rich-tooltip-container>

      <div class="filler"></div>
      <a
        mat-button
        class="use-template"
        color="primary"
        href="https://docs.google.com/spreadsheets/d/1sjaGTCs3J9CjrkowxkyJrIfHk64w_nDyYrgprbMbdqE/edit?gid=0#gid=0"
        target="_blank"
        rel="noopener noreferrer"
        hraFeature="color-template"
        hraClickEvent
      >
        Template
      </a>
    </h2>

    <mat-button-toggle-group
      formControlName="colorMapType"
      name="singleSelect"
      aria-label="Single Select"
      hideSingleSelectionIndicator
      hraButtonToggleSize="large"
    >
      <mat-button-toggle disableRipple value="default" hraFeature="toggle.default" hraClickEvent
        >Use Default Colors</mat-button-toggle
      >
      <mat-button-toggle
        disableRipple
        value="custom"
        data-testid="upload-custom"
        hraFeature="toggle.custom"
        hraClickEvent
        >Upload Color Map</mat-button-toggle
      >
    </mat-button-toggle-group>

    @if (useCustomColorMap) {
      <table aria-label="custom color map requirements">
        <tr>
          <th>Required Columns</th>
          <th>Supported Format</th>
          <th></th>
          <th></th>
        </tr>
        <tr>
          <td>• <span>Cell Type</span></td>
          <td>• <span>CSV</span></td>
        </tr>
        <tr>
          <td>• <span>HEX</span></td>
        </tr>
      </table>
      <cde-file-upload
        class="upload-colormap"
        accept="text/csv,.csv"
        [loader]="colorMapLoader"
        [options]="colorMapLoaderOptions"
        (loadCompleted)="setCustomColorMap($event[0])"
        (loadCancelled)="clearCustomColorMap()"
        (loadErrored)="customColorMapLoadError = $event; colorProgress = 0"
        [errorMessage]="colorErrorMessage"
        [errorActionMessage]="colorErrorActionMessage"
        (progress)="colorProgress = $event"
        #customColorMapFileUpload
        data-testid="color-map-upload"
      >
      </cde-file-upload>
    }
  </hra-workflow-card>

  <hra-workflow-card class="card visualize" hraFeature="visualize-data">
    <h2 class="header">
      <hra-step-indicator class="step-number" [value]="6"></hra-step-indicator>
      <div class="card-title">Visualize Cell Distance Data</div>
      <hra-info-button [richTooltipContent]="cellDistanceTooltip" />

      <hra-rich-tooltip-container #cellDistanceTooltip>
        <hra-rich-tooltip-content>
          <hra-tooltip-card [content]="tooltips[5]"> </hra-tooltip-card>
        </hra-rich-tooltip-content>
      </hra-rich-tooltip-container>
    </h2>

    @if (!hasValidNodes() || !hasValidData()) {
      <hra-error-indicator [errors]="['Please upload a dataset.']"></hra-error-indicator>
    }

    <button
      class="visualize-button"
      mat-button
      hraCtaButton
      hraPrimaryButton
      [disabled]="!hasValidNodes() || !hasValidData()"
      data-testid="visualize"
      (click)="submit()"
      hraFeature="submit"
      hraClickEvent
    >
      Visualize
      <mat-icon class="material-symbols-rounded" iconPositionEnd>arrow_right_alt</mat-icon>
    </button>
  </hra-workflow-card>
</form>
<hra-footer></hra-footer>
